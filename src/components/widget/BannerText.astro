---
import { siteConfig } from "@/config";
import Typewriter from "./Typewriter.astro";

const { title, subtitle, color, quoteFloat } = siteConfig.banner.text || {};
// 过滤掉空的 text，允许在数据文件中保留空占位符
const validSubtitles = subtitle?.filter((s) => s.text && s.text.trim() !== '') || [];
const subtitleTexts = validSubtitles.map((s) => s.text);
const subtitleData = validSubtitles;

function getColorOrDefault(
	colorValue: { light: string; dark: string } | "default" | undefined,
) {
	return colorValue === "default" || !colorValue
		? { light: "#ffffff", dark: "#ffffff" }
		: colorValue;
}

const titleColor = getColorOrDefault(color?.title);
const subtitleColor = getColorOrDefault(color?.subtitle);
const authorColor = getColorOrDefault(color?.author);
---

{(title || (subtitle && subtitle.length > 0)) && (
    <div class="banner-text-container text-center pointer-events-none select-none w-full px-4 sm:px-8 max-w-[min(90%,1200px)] mb-8 md:mb-0">
        {title && (
            <h1 class="banner-title text-3xl sm:text-4xl md:text-5xl font-bold mb-8 tracking-wider break-words" style={titleColor ? `color: light-dark(${titleColor.light}, ${titleColor.dark})` : undefined}>{title}</h1>
        )}
        
        {validSubtitles.length > 0 && (
            <div class="relative inline-block max-w-full">
                <!-- 装饰引号 -->
                <span class="quote-left absolute -top-4 -left-6 sm:-left-8 md:-left-10 text-xl sm:text-2xl md:text-3xl opacity-0 transition-opacity duration-300" class:list={[quoteFloat && 'quote-float']} style={subtitleColor ? `color: light-dark(${subtitleColor.light}, ${subtitleColor.dark})` : undefined}>『</span>
                <span class="quote-right absolute -bottom-4 -right-6 sm:-right-8 md:-right-10 text-xl sm:text-2xl md:text-3xl opacity-0 transition-opacity duration-300" class:list={[quoteFloat && 'quote-float-delayed']} style={subtitleColor ? `color: light-dark(${subtitleColor.light}, ${subtitleColor.dark})` : undefined}>』</span>
                
                <!-- 打字机文本 -->
                <div class="text-lg sm:text-xl md:text-2xl font-medium min-h-[2rem] px-2" style={subtitleColor ? `color: light-dark(${subtitleColor.light}, ${subtitleColor.dark})` : undefined}>
                    <Typewriter 
                        words={subtitleTexts}
                        typeSpeed={100}
                        deleteSpeed={50}
                        delay={3000}
                        startDelay={2000}
                        class="drop-shadow-md break-words"
                    />
                </div>
                
                <!-- 作者显示区域（动态显示） -->
                <div class="absolute -bottom-8 sm:-bottom-10 left-0 right-0 flex justify-center">
                    <div 
                        class="typewriter-author text-xs sm:text-sm md:text-base font-light tracking-wide opacity-0 transition-opacity duration-1000 max-w-[90vw] px-2 whitespace-nowrap"
                        style={authorColor ? `color: light-dark(${authorColor.light}, ${authorColor.dark})` : undefined}
                        data-authors={JSON.stringify(subtitleData)}
                    ></div>
                </div>
            </div>
        )}
    </div>
)}

<script>
// Banner 文本可见性控制和作者显示逻辑
class BannerTextController {
    // 时间配置常量
    private static readonly AUTHOR_DISPLAY_TIME = 4000; // 作者显示时间
    private static readonly AUTHOR_CLEAR_DELAY = 1200;  // 作者元素内容清空延迟（略长于 1000ms transition）

    private container: HTMLElement | null;
    private authorElement: HTMLElement | null;
    private typewriterElement: HTMLElement | null = null;
    private authors: Array<{ text: string; author?: string }> = [];
    private hideAuthorTimeout: number | null = null;
    
    // 事件监听器引用（用于清理）
    private onTypewriterComplete: EventListener | null = null;
    private onTypewriterDeleted: EventListener | null = null;

    constructor() {
        this.container = document.querySelector('.banner-text-container');
        this.authorElement = document.querySelector('.typewriter-author');
        
        // 清空可能被缓存的文本内容
        if (this.authorElement) {
            this.authorElement.classList.remove('show-author');
            this.authorElement.textContent = '';
        }
        
        if (this.authorElement?.dataset.authors) {
            try {
                this.authors = JSON.parse(this.authorElement.dataset.authors);
            } catch (error) {
                console.error('解析作者数据失败:', error);
            }
        }
        
        this.setupTypewriterListeners();
    }

    // 设置打字机事件监听器（延迟查询确保 Typewriter 已初始化）
    private setupTypewriterListeners() {
        requestAnimationFrame(() => {
            this.typewriterElement = document.querySelector('.typewriter-text');
            
            if (!this.typewriterElement) return;

            // 创建并存储事件监听器引用
            this.onTypewriterComplete = ((event: CustomEvent) => {
                const { index } = event.detail;
                this.showAuthor(index);
            }) as EventListener;

            this.onTypewriterDeleted = (() => {
                this.hideAuthor();
            }) as EventListener;

            this.typewriterElement.addEventListener('typewriter:complete', this.onTypewriterComplete);
            this.typewriterElement.addEventListener('typewriter:deleted', this.onTypewriterDeleted);
        });
    }

    // 显示指定索引的作者
    private showAuthor(index: number) {
        // 检查作者字段是否存在且不为空（包括只有空格的情况）
        const author = this.authors[index]?.author?.trim();
        if (!this.authorElement || !author) return;

        this.authorElement.textContent = `—— 「 ${author} 」`;
        
        // 显示作者元素
        requestAnimationFrame(() => {
            this.authorElement?.classList.add('show-author');
        });

        if (this.hideAuthorTimeout) {
            clearTimeout(this.hideAuthorTimeout);
        }

        // 使用同步的显示时间
        this.hideAuthorTimeout = window.setTimeout(() => {
            this.hideAuthor();
        }, BannerTextController.AUTHOR_DISPLAY_TIME);
    }

    private hideAuthor() {
        if (!this.authorElement) return;
        
        this.authorElement.classList.remove('show-author');
        
        // 清空延迟（略长于 CSS transition 时间）
        setTimeout(() => {
            if (this.authorElement && !this.authorElement.classList.contains('show-author')) {
                this.authorElement.textContent = '';
            }
        }, BannerTextController.AUTHOR_CLEAR_DELAY);
    }

    public destroy() {
        // 清理定时器
        if (this.hideAuthorTimeout) {
            clearTimeout(this.hideAuthorTimeout);
            this.hideAuthorTimeout = null;
        }

        // 移除事件监听器
        if (this.typewriterElement) {
            if (this.onTypewriterComplete) {
                this.typewriterElement.removeEventListener('typewriter:complete', this.onTypewriterComplete);
                this.onTypewriterComplete = null;
            }
            if (this.onTypewriterDeleted) {
                this.typewriterElement.removeEventListener('typewriter:deleted', this.onTypewriterDeleted);
                this.onTypewriterDeleted = null;
            }

            // 销毁打字机实例
            const typewriterInstance = (this.typewriterElement as any).__typewriter;
            if (typewriterInstance) {
                typewriterInstance.destroy();
            }
        }
    }
}

let bannerTextController: BannerTextController | null = null;

function initBannerText() {
    if (document.querySelector('.banner-text-container')) {
        bannerTextController = new BannerTextController();
    }
}

function cleanup() {
    if (bannerTextController) {
        bannerTextController.destroy();
        bannerTextController = null;
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBannerText);
} else {
    initBannerText();
}

// 支持页面切换
document.addEventListener('astro:page-load', () => {
    cleanup();
    initBannerText();
});

document.addEventListener('astro:before-swap', cleanup);
</script>

<style>

    /* 引号显示效果 */
    .quote-left,
    .quote-right {
        opacity: 0.8;
    }

    /* 引号浮动动画 */
    .quote-float {
        animation: float 4s ease-in-out infinite;
    }

    .quote-float-delayed {
        animation: float 4s ease-in-out infinite 2s;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-8px); }
    }

    /* 主标题增强可读性 */
    .banner-title {
        text-shadow: 
            0 0 3.5px oklch(0.75 0.14 var(--hue) / 0.575);
        -webkit-text-stroke: 0.5px rgba(0,0,0,0.2);
        paint-order: stroke fill;
    }

    /* 作者显示/隐藏动画 */
    .typewriter-author {
        transition: 
            opacity 1000ms ease,
            transform 1000ms ease;
        opacity: 0;
        transform: translateY(-5px);
    }

    .typewriter-author.show-author {
        opacity: 1;
        transform: translateY(0);
    }
</style>
