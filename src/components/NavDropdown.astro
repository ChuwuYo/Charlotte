---
import { Icon } from "astro-icon/components";
import { url } from "../utils/url-utils";

interface DropdownItem {
    name: string;
    url: string;
    external?: boolean;
}

interface Props {
    title: string;
    items: DropdownItem[];
    class?: string;
}

const { title, items, class: className } = Astro.props;
const dropdownId = `dropdown-${title.toLowerCase()}`;
---

<!-- 事件委托避免全局函数 -->
<div 
    class={`relative z-50 ${className || ''}`} 
    role="menu" 
    tabindex="-1" 
    id={dropdownId}
    data-dropdown-container
>
    <button 
        aria-label={`${title} Menu`} 
        role="menuitem" 
        class="relative btn-plain scale-animation rounded-lg h-11 font-bold px-5 active:scale-95 flex items-center gap-1" 
        data-dropdown-trigger
    >
        {title}
        <Icon name="material-symbols:keyboard-arrow-down-rounded" class="text-[1rem] transition-transform" />
    </button>

    <div 
        class="hidden lg:block absolute transition float-panel-closed top-11 -right-2 pt-5"
        data-dropdown-panel
    >
        <div class="card-base float-panel p-2">
            {items.map((item) => (
                <a 
                    href={item.external ? item.url : url(item.url)} 
                    target={item.external ? "_blank" : null}
                    class="flex transition whitespace-nowrap items-center !justify-start w-full btn-plain scale-animation rounded-lg h-9 px-3 font-medium active:scale-95 mb-0.5 last:mb-0"
                >
                    <span class="mr-3">{item.name}</span>
                    {item.external && (
                        <Icon name="fa6-solid:arrow-up-right-from-square" class="text-[0.875rem] transition -translate-y-[1px] ml-auto text-black/[0.2] dark:text-white/[0.2]" />
                    )}
                </a>
            ))}
        </div>
    </div>
</div>

<script>
// 事件委托和作用域封装，避免全局污染
(function() {
    function initDropdown() {
        // 为所有下拉菜单容器添加事件监听器
        const dropdownContainers = document.querySelectorAll('[data-dropdown-container]');
        
        dropdownContainers.forEach(container => {
            const panel = container.querySelector('[data-dropdown-panel]');
            if (!panel) return;
            
            // 鼠标进入时显示面板
            container.addEventListener('mouseenter', function() {
                panel.classList.remove('float-panel-closed');
            });
            
            // 鼠标离开时隐藏面板
            container.addEventListener('mouseleave', function() {
                panel.classList.add('float-panel-closed');
            });
        });
    }
    
    // 页面加载时初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDropdown);
    } else {
        initDropdown();
    }
    
    // 处理 Swup 页面转换
    if (typeof window !== 'undefined') {
        const setupSwup = () => {
            if (window?.swup?.hooks) {
                window.swup.hooks.on('page:view', initDropdown);
            }
        };
        
        if (window.swup) {
            setupSwup();
        } else {
            document.addEventListener('swup:enable', setupSwup);
        }
    }
})();
</script>