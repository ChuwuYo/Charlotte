---
import { Icon } from "astro-icon/components";
import { type NavBarLink } from "../types/config";
import { url } from "../utils/url-utils";

interface Props {
	title: string;
	items: NavBarLink[];
	class?: string;
}

const { title, items, class: className } = Astro.props;
const dropdownId = `dropdown-${title.toLowerCase()}`;
---

<!-- 事件委托避免全局函数 -->
<div 
    class={`relative z-50 ${className || ''}`} 
    role="menu" 
    tabindex="-1" 
    id={dropdownId}
    data-dropdown-container
>
    <button 
        aria-label={`${title} Menu`} 
        role="menuitem" 
        class="relative btn-plain scale-animation rounded-lg h-11 font-bold px-5 active:scale-95 flex items-center gap-1" 
        data-dropdown-trigger
    >
        {title}
        <Icon name="material-symbols:keyboard-arrow-down-rounded" class="text-[1rem] transition-transform" />
    </button>

    <div 
        class="absolute transition float-panel-closed top-11 -right-2 pt-5"
        data-dropdown-panel
    >
        <div class="card-base float-panel p-2">
            {items.map((item) => (
                <a 
                    href={item.external ? item.url : url(item.url)} 
                    target={item.external ? "_blank" : null}
                    class="flex transition whitespace-nowrap items-center !justify-start w-full btn-plain scale-animation rounded-lg h-9 px-3 font-medium active:scale-95 mb-0.5 last:mb-0"
                    data-dropdown-item
                >
                    <span class="mr-3">{item.name}</span>
                    {item.external && (
                        <Icon name="fa6-solid:arrow-up-right-from-square" class="text-[0.875rem] transition -translate-y-[1px] ml-auto text-black/[0.2] dark:text-white/[0.2]" />
                    )}
                </a>
            ))}
        </div>
    </div>
</div>

<script>
// 事件委托和作用域封装，避免全局污染
(function() {
    // 全局事件监听器管理
    let globalListenersAdded = false;
    
    // 自定义事件：关闭所有下拉菜单
    const CLOSE_DROPDOWN_EVENT = 'dropdown:close';
    
    function addGlobalListeners() {
        if (globalListenersAdded) return;
        
        // 全局点击监听器 - 只添加一次
        document.addEventListener('click', function(e) {
            const clickedDropdown = (e.target as Element)?.closest('[data-dropdown-container]');
            if (!clickedDropdown) {
                // 点击了外部区域，关闭所有下拉菜单
                document.dispatchEvent(new CustomEvent(CLOSE_DROPDOWN_EVENT));
            }
        });
        
        // 全局键盘监听器 - 只添加一次
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.dispatchEvent(new CustomEvent(CLOSE_DROPDOWN_EVENT));
            }
        });
        
        globalListenersAdded = true;
    }
    
    function initDropdown() {
        // 确保全局监听器只添加一次
        addGlobalListeners();
        
        // 为所有下拉菜单容器添加事件监听器
        const dropdownContainers = document.querySelectorAll('[data-dropdown-container]');
        
        dropdownContainers.forEach(container => {
            const trigger = container.querySelector('[data-dropdown-trigger]');
            const panel = container.querySelector('[data-dropdown-panel]');
            const icon = trigger?.querySelector('svg');
            if (!panel || !trigger) return;
            
            // 避免重复绑定
            if ((container as HTMLElement).dataset.dropdownInitialized) return;
            (container as HTMLElement).dataset.dropdownInitialized = 'true';
            
            let isOpen = false;
            
            // 切换下拉框状态
            function toggleDropdown() {
                const shouldOpen = !isOpen;
                // 切换前先关闭所有已打开的下拉菜单，确保只有一个菜单是打开的
                document.dispatchEvent(new CustomEvent(CLOSE_DROPDOWN_EVENT));

                if (shouldOpen) {
                    isOpen = true;
                    panel?.classList.remove('float-panel-closed');
                    icon?.style.setProperty('transform', 'rotate(180deg)');
                }
            }
            
            // 关闭下拉框
            function closeDropdown() {
                if (isOpen) {
                    isOpen = false;
                    panel?.classList.add('float-panel-closed');
                    icon?.style.setProperty('transform', 'rotate(0deg)');
                }
            }
            
            // 点击按钮切换下拉框
            trigger.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleDropdown();
            });
            
            // 桌面端：鼠标悬停显示（仅当未通过点击打开时）
            container.addEventListener('mouseenter', function() {
                if (!isOpen) {
                    panel?.classList.remove('float-panel-closed');
                    icon?.style.setProperty('transform', 'rotate(180deg)');
                }
            });
            
            // 桌面端：鼠标离开隐藏（仅当未通过点击打开时）
            container.addEventListener('mouseleave', function() {
                if (!isOpen) {
                    panel?.classList.add('float-panel-closed');
                    icon?.style.setProperty('transform', 'rotate(0deg)');
                }
            });
            
            // 监听自定义关闭事件
            document.addEventListener(CLOSE_DROPDOWN_EVENT, closeDropdown);
            
            // 为下拉菜单项添加点击关闭逻辑
            const dropdownItems = container.querySelectorAll('[data-dropdown-item]');
            dropdownItems.forEach(item => {
                item.addEventListener('click', function() {
                    // 点击菜单项时关闭下拉菜单
                    closeDropdown();
                });
            });
        });
    }
    
    // 清理函数 - 在页面转换时调用
    function cleanup() {
        // 清理初始化标记，允许重新初始化
        const containers = document.querySelectorAll('[data-dropdown-container]');
        containers.forEach(container => {
            delete (container as HTMLElement).dataset.dropdownInitialized;
        });
    }
    
    // 使用统一的Swup处理器模式 (来自 src/utils/swup-utils.ts)
    function createSwupHandler(initFunction: () => void) {
        // 页面加载时初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initFunction);
        } else {
            initFunction();
        }
        
        // 处理 Swup 页面转换
        if (typeof window !== 'undefined') {
            const setupSwup = () => {
                if (window?.swup?.hooks) {
                    // 页面转换前清理
                    window.swup.hooks.on('content:replace', cleanup);
                    // 页面转换后重新初始化
                    window.swup.hooks.on('page:view', initFunction);
                }
            };
            
            if (window.swup) {
                setupSwup();
            } else {
                document.addEventListener('swup:enable', setupSwup);
            }
        }
    }
    
    // 使用统一的处理器
    createSwupHandler(initDropdown);
})();
</script>