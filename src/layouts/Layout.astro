---
import "@fontsource/roboto/400.css";
import "@fontsource/roboto/500.css";
import "@fontsource/roboto/700.css";

import ConfigCarrier from "@components/ConfigCarrier.astro";
import { profileConfig, siteConfig } from "@/config";
import {
	AUTO_MODE,
	BANNER_HEIGHT,
	BANNER_HEIGHT_EXTEND,
	BANNER_HEIGHT_HOME,
	DARK_MODE,
	DEFAULT_THEME,
	LIGHT_MODE,
	PAGE_WIDTH,
} from "../constants/constants";
import { defaultFavicons } from "../constants/icon";
import type { Favicon } from "../types/config";
import { pathsEqual, url } from "../utils/url-utils";
import "katex/dist/katex.css";

interface Props {
	title?: string;
	banner?: string;
	description?: string;
	lang?: string;
	setOGTypeArticle?: boolean;
}

let { title, banner, description, lang, setOGTypeArticle } = Astro.props;

// apply a class to the body element to decide the height of the banner, only used for initial page load
// Swup can update the body for each page visit, but it's after the page transition, causing a delay for banner height change
// so use Swup hooks instead to change the height immediately when a link is clicked
const isHomePage = pathsEqual(Astro.url.pathname, url("/"));

// defines global css variables
// why doing this in Layout instead of GlobalStyles: https://github.com/withastro/astro/issues/6728#issuecomment-1502203757
const configHue = siteConfig.themeColor.hue;
if (!banner || typeof banner !== "string" || banner.trim() === "") {
	banner = siteConfig.banner.src;
}

// TODO don't use post cover as banner for now
banner = siteConfig.banner.src;

const enableBanner = siteConfig.banner.enable;

let pageTitle: string;
if (title) {
	pageTitle = `${title} - ${siteConfig.title}`;
} else {
	pageTitle = `${siteConfig.title} - ${siteConfig.subtitle}`;
}

// 定义 finalDescription 变量，优先使用页面传入的 description，否则使用全局配置，就避免回退到 pageTitle
const finalDescription = description || siteConfig.description;

const favicons: Favicon[] =
	siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;

// const siteLang = siteConfig.lang.replace('_', '-')
if (!lang) {
	lang = `${siteConfig.lang}`;
}
const siteLang = lang.replace("_", "-");

const bannerOffsetByPosition = {
	top: `${BANNER_HEIGHT_EXTEND}vh`,
	center: `${BANNER_HEIGHT_EXTEND / 2}vh`,
	bottom: "0",
};
const bannerOffset =
	bannerOffsetByPosition[siteConfig.banner.position || "center"];

// 外链 hover 预热（仅使用配置中的链接表；为空则不执行）
const externalLinkWarmupConfig = siteConfig.performance?.externalLinkWarmup;
const enableExternalLinkWarmup = externalLinkWarmupConfig?.enable !== false;
const enableExternalLinkFetchWarmup =
	externalLinkWarmupConfig?.enableFetch !== false;

const warmupUrls: string[] = enableExternalLinkWarmup
	? (externalLinkWarmupConfig?.urls ?? [])
	: [];

const hoverPrefetchOrigins: string[] = Array.from(
	new Set(
		warmupUrls
			.map((linkUrl) => {
				if (!/^https?:\/\//i.test(linkUrl)) return null;
				try {
					return new URL(linkUrl).origin;
				} catch {
					return null;
				}
			})
			.filter((v): v is string => typeof v === "string"),
	),
);

// 用于 head 中 dns-prefetch 的域名列表（由 origin 派生并去重）
// 这里的 origin 来自 new URL(linkUrl).origin，已保证是合法 URL
const hoverPrefetchHosts: string[] = Array.from(
	new Set(hoverPrefetchOrigins.map((origin) => new URL(origin).host)),
);
---

<!DOCTYPE html>
<!-- 
	Font size scaling for different screen sizes:
	- default (mobile): 14px
	- md (tablet, 768px+): 15px
	- lg (laptop, 1024px+): 14px (slightly smaller for better fit)
	- 2xl (large desktop, 1536px+): 13px (more compact)
-->
<html lang={siteLang} class="bg-[var(--page-bg)] transition"
	  data-overlayscrollbars-initialize
>
	<head>

		<title>{pageTitle}</title>

		<meta charset="UTF-8" />
		<meta name="keywords" content={siteConfig.keywords}>
		<meta name="description" content={finalDescription}>
		<meta name="author" content={profileConfig.name}>

		<meta property="og:site_name" content={siteConfig.title}>
		<meta property="og:url" content={Astro.url}>
		<meta property="og:title" content={pageTitle}>
		<meta property="og:description" content={finalDescription}>
		{setOGTypeArticle ? (
		<meta property="og:type" content="article" />
		) : (
		<meta property="og:type" content="website" />
		)}

		<meta name="twitter:card" content="summary_large_image">
		<meta property="twitter:url" content={Astro.url}>
		<meta name="twitter:title" content={pageTitle}>
		<meta name="twitter:description" content={finalDescription}>

		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="generator" content={Astro.generator} />
		{favicons.map(favicon => (
			<link rel="icon"
				  href={favicon.src.startsWith('/') ? url(favicon.src) : favicon.src}
				  sizes={favicon.sizes}
				  media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
			/>
		))}

		{enableExternalLinkWarmup ? (
			<>
				<!-- 外链预热：按配置生成 dns-prefetch（低成本 DNS 提示） -->
				{hoverPrefetchHosts.map((host) => (
					<link rel="dns-prefetch" href={`//${host}`} />
				))}
			</>
		) : null}

		<!-- Set the theme before the page is rendered to avoid a flash -->
		<script is:inline define:vars={{DEFAULT_THEME, LIGHT_MODE, DARK_MODE, AUTO_MODE, BANNER_HEIGHT_EXTEND, PAGE_WIDTH, configHue}}>
			// Load the theme from local storage
			const theme = localStorage.getItem('theme') || DEFAULT_THEME;
			switch (theme) {
				case LIGHT_MODE:
					document.documentElement.classList.remove('dark');
					break
				case DARK_MODE:
					document.documentElement.classList.add('dark');
					break
				case AUTO_MODE:
					if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
						document.documentElement.classList.add('dark');
					} else {
						document.documentElement.classList.remove('dark');
					}
			}

			// Load the hue from local storage
			const hue = localStorage.getItem('hue') || configHue;
			document.documentElement.style.setProperty('--hue', hue);


			// calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
			let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
			offset = offset - offset % 4;
			document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);

			// 加载字体缩放策略
			const fontScalingType = localStorage.getItem("fontScalingType");
			// FONT_SCALING_TYPE.RESPONSIVE = 1
			if (fontScalingType === "1") {
				document.documentElement.classList.add("font-scale-dynamic");
			} else {
				document.documentElement.classList.remove("font-scale-dynamic");
			}
		</script>
		<style is:global define:vars={{
			configHue,
			'page-width': PAGE_WIDTH,
			'font-size-base': '15px',
			'font-size-md': '16px',
			'font-size-lg': '15px',
			'font-size-2xl': '14px',
		}}>
			html {
				font-size: var(--font-size-base);
			}
			@media (min-width: 768px) {
				html {
					font-size: var(--font-size-md);
				}
			}
			@media (min-width: 1024px) {
				html {
					font-size: var(--font-size-lg);
				}
			}
			@media (min-width: 1536px) {
				html {
					font-size: var(--font-size-2xl);
				}
			}

			/* 动态字体缩放模式：使用百分比值 */
			html.font-scale-dynamic {
				--font-size-base: 93.75% !important;
				--font-size-md: 100% !important;
				--font-size-lg: 93.75% !important;
				--font-size-2xl: 87.5% !important;
			}
		</style>

		<slot name="head"></slot>

		<link rel="alternate" type="application/rss+xml" title={profileConfig.name} href={`${Astro.site}rss.xml`}/>
		<link rel="alternate" type="application/atom+xml" title={profileConfig.name} href={`${Astro.site}atom.xml`}/>

		<script is:inline define:vars={{ hoverPrefetchOrigins, enableExternalLinkWarmup, enableExternalLinkFetchWarmup }}>
		// 外链预热（由 src/utils/useExternalLinkWarmup.ts 实现）：
		// - dns-prefetch：静态 <link>
		// - preconnect：hover 时注入
		// - fetch：hover 时预热（可通过配置开关关闭）
		window.__externalLinkWarmupConfig = {
			enable: enableExternalLinkWarmup,
			enableFetch: enableExternalLinkFetchWarmup,
			origins: hoverPrefetchOrigins,
		};
		</script>

	</head>
	<body class=" min-h-screen transition " class:list={[{"is-home": isHomePage, "enable-banner": enableBanner}]}
		  data-overlayscrollbars-initialize
	>
		<ConfigCarrier></ConfigCarrier>
		<slot />

		<!-- increase the page height during page transition to prevent the scrolling animation from jumping -->
		<div id="page-height-extend" class="hidden h-[300vh]"></div>
	</body>
</html>

<style is:global define:vars={{
	bannerOffset,
	'banner-height-home': `${BANNER_HEIGHT_HOME}vh`,
	'banner-height': `${BANNER_HEIGHT}vh`,
}}>
@tailwind components;
@layer components {
	.enable-banner.is-home #banner-wrapper {
		@apply h-[var(--banner-height-home)] translate-y-[var(--banner-height-extend)]
	}
	.enable-banner #banner-wrapper {
		@apply h-[var(--banner-height-home)]
	}

	.enable-banner.is-home #banner {
		@apply h-[var(--banner-height-home)] translate-y-0
	}
	.enable-banner #banner {
		@apply h-[var(--banner-height-home)] translate-y-[var(--bannerOffset)]
	}
	.enable-banner.is-home #main-grid {
		@apply translate-y-[var(--banner-height-extend)];
	}
	.enable-banner #top-row {
		@apply h-[calc(var(--banner-height-home)_-_4.5rem)] transition-all duration-300
	}
	.enable-banner.is-home #sidebar-sticky {
		@apply top-[calc(1rem_-_var(--banner-height-extend))]
	}
	.navbar-hidden {
		@apply opacity-0 -translate-y-16
	}
}
</style>

<script>
import 'overlayscrollbars/overlayscrollbars.css';
import {
	OverlayScrollbars,
	// ScrollbarsHidingPlugin,
	// SizeObserverPlugin,
	// ClickScrollPlugin
} from 'overlayscrollbars';
import { setupExternalLinkWarmup } from "../utils/useExternalLinkWarmup";
import {getHue, getStoredTheme, setHue, setTheme} from "../utils/setting-utils";
import {pathsEqual, url} from "../utils/url-utils";
import {
	BANNER_HEIGHT,
	BANNER_HEIGHT_HOME,
	BANNER_HEIGHT_EXTEND,
	MAIN_PANEL_OVERLAPS_BANNER_HEIGHT,
	NAVBAR_HEIGHT
} from "../constants/constants";
import { siteConfig } from '../config';

/* Preload fonts */
// (async function() {
// 	try {
// 		await Promise.all([
// 			document.fonts.load("400 1em Roboto"),
// 			document.fonts.load("700 1em Roboto"),
// 		]);
// 		document.body.classList.remove("hidden");
// 	} catch (error) {
// 		console.log("Failed to load fonts:", error);
// 	}
// })();

/* TODO This is a temporary solution for style flicker issue when the transition is activated */
/* issue link: https://github.com/withastro/astro/issues/8711, the solution get from here too */
/* update: fixed in Astro 3.2.4 */
/*
function disableAnimation() {
	const css = document.createElement('style')
	css.appendChild(
		document.createTextNode(
			`*{
              -webkit-transition:none!important;
              -moz-transition:none!important;
              -o-transition:none!important;
              -ms-transition:none!important;
              transition:none!important
              }`
		)
	)
	document.head.appendChild(css)

	return () => {
		// Force restyle
		;(() => window.getComputedStyle(document.body))()

		// Wait for next tick before removing
		setTimeout(() => {
			document.head.removeChild(css)
		}, 1)
	}
}
*/

const bannerEnabled = !!document.getElementById('banner-wrapper')

/*
 * ============================================================================
 * 代码组织说明 - 后期可提取到独立模块的功能块
 * ============================================================================
 * 
 * 当前 Layout.astro 包含多个功能领域，如文件增长到 1000+ 行，应分割为：
 * 
 * 1. useScrollVisibility.ts
 *    - scrollFunction(): 控制 BackToTop、CollapsibleTOC、TOC 的滚动显示
 *    - updateScrollElements(): 更新 DOM 元素引用
 *    - 相关常量：backToTopBtn, toc, navbar
 * 
 * 2. useCollapsibleTOC.ts
 *    - toggleCollapsibleTOC(): 打开/关闭面板
 *    - closeCollapsibleTOC(): 关闭并隐藏
 *    - 事件监听：ESC、链接点击、动画回调
 *    - TOC 同步滚动逻辑
 * 
 * 3. useSwupHooks.ts
 *    - visit:start: 页面切换前的清理（关闭 CollapsibleTOC、KaTeX、TOC 等）
 *    - visit:end: 页面切换后的初始化（滚动元素、CollapsibleTOC）
 *    - content:replace: DOM 替换后的回调（KaTeX、滚动条）
 *    - link:click: 链接点击时的处理
 * 
 * 4. usePhotoSwipe.ts (已基本独立，可进一步提取)
 * 
 * 6. Layout 保留：初始化流程、全局 UI 设置、类型定义
 * ============================================================================
 */

// 面板配置 - 使用事件委托，只注册一次 click 监听器
const PANEL_CONFIG = [
	{ id: "display-setting", ignores: ["display-setting", "display-settings-switch"] },
	{ id: "nav-menu-panel", ignores: ["nav-menu-panel", "nav-menu-switch"] },
	{ id: "search-panel", ignores: ["search-panel", "search-bar", "search-switch"] },
	{ id: "font-settings-panel", ignores: ["font-settings-panel", "font-settings-switch"] }
];

let clickHandlerInitialized = false;

function setupClickOutsideHandlers() {
	// 防止重复初始化
	if (clickHandlerInitialized) return;
	clickHandlerInitialized = true;

	document.addEventListener("click", event => {
		const target = event.target;
		if (!(target instanceof Node)) return;

		PANEL_CONFIG.forEach(({ id, ignores }) => {
			const panelDom = document.getElementById(id);
			let shouldClose = true;

			for (let ig of ignores) {
				const ie = document.getElementById(ig);
				if (ie === target || ie?.contains(target)) {
					shouldClose = false;
					break;
				}
			}

			if (shouldClose && panelDom) {
				panelDom.classList.add("float-panel-closed");
			}
		});
	});
}

// 在脚本加载时调用一次
if (document.readyState === 'loading') {
	document.addEventListener('DOMContentLoaded', setupClickOutsideHandlers, { once: true });
} else {
	setupClickOutsideHandlers();
}


function loadTheme() {
	const theme = getStoredTheme()
	setTheme(theme)
}

function loadHue() {
	setHue(getHue())
}

// Store instances - body scrollbar persists, katex observer is recreated per page
let bodyScrollbarInstance: ReturnType<typeof OverlayScrollbars> | null = null;
let katexObserver: IntersectionObserver | null = null;

function initCustomScrollbar() {
	const bodyElement = document.querySelector('body');
	if (!bodyElement) return;

	// Only initialize body scrollbar once, it persists across page transitions
	if (!bodyScrollbarInstance) {
		// docs say that a initialization to the body element would affect native functionality like window.scrollTo
		// but just leave it here for now
		bodyScrollbarInstance = OverlayScrollbars(
			{
				target: bodyElement,
				cancel: {
					nativeScrollbarsOverlaid: true,    // don't initialize the overlay scrollbar if there is a native one
				}
			}, {
			scrollbars: {
				theme: 'scrollbar-base scrollbar-auto py-1',
				autoHide: 'move',
				autoHideDelay: 500,
				autoHideSuspend: false,
			},
		});
	}

	const katexElements = document.querySelectorAll('.katex-display') as NodeListOf<HTMLElement>;

	const katexObserverOptions = {
		root: null,
		rootMargin: '100px',
		threshold: 0.1
	};

	const processKatexElement = (element: HTMLElement) => {
		if (!element.parentNode) return;
		if (element.hasAttribute('data-scrollbar-initialized')) return;

		const container = document.createElement('div');
		container.className = 'katex-display-container';
		container.setAttribute('aria-label', 'scrollable container for formulas');

		element.parentNode.insertBefore(container, element);
		container.appendChild(element);

		// KaTeX scrollbar instances are automatically cleaned up when containers are removed from DOM
		OverlayScrollbars(container, {
			scrollbars: {
				theme: 'scrollbar-base scrollbar-auto',
				autoHide: 'leave',
				autoHideDelay: 500,
				autoHideSuspend: false
			}
		});

		element.setAttribute('data-scrollbar-initialized', 'true');
	};

	// Disconnect existing observer before creating new one (defensive)
	if (katexObserver) {
		katexObserver.disconnect();
	}

	katexObserver = new IntersectionObserver((entries, observer) => {
		entries.forEach(entry => {
			if (entry.isIntersecting) {
				processKatexElement(entry.target as HTMLElement);
				observer.unobserve(entry.target);
			}
		});
	}, katexObserverOptions);

	katexElements.forEach(element => {
		katexObserver!.observe(element);
	});
}

function showBanner() {
	if (!siteConfig.banner.enable) return;

	const banner = document.getElementById('banner');
	if (!banner) {
		console.error('Banner element not found');
		return;
	}

	banner.classList.remove('opacity-0', 'scale-105');
}

// Scroll-related elements - declared here so scrollFunction can be called in init()
let backToTopBtn: HTMLElement | null = null;
let toc: HTMLElement | null = null;
let navbar: HTMLElement | null = null;

function updateScrollElements() {
	backToTopBtn = document.getElementById('back-to-top-btn');
	toc = document.getElementById('toc-wrapper');
	navbar = document.getElementById('navbar-wrapper');
}

function scrollFunction() {
	let bannerHeight = window.innerHeight * (BANNER_HEIGHT / 100)

	// BackToTop button: show when scrolled past banner
	if (backToTopBtn) {
		if (document.body.scrollTop > bannerHeight || document.documentElement.scrollTop > bannerHeight) {
			backToTopBtn.classList.remove('hide')
		} else {
			backToTopBtn.classList.add('hide')
		}
	}

	// CollapsibleTOC button visibility
	// 注意：CollapsibleTOC 在 #swup-container 内，Swup 导航会重新创建 DOM
	// 所以必须动态查询元素，不能缓存引用（与 BackToTop 不同）
	const collapsibleTocBtn = document.getElementById('collapsible-toc-btn');
	const collapsibleTocPanel = document.getElementById('collapsible-toc-panel');
	
	if (collapsibleTocBtn && collapsibleTocPanel) {
		// Only show when scrolled past banner AND panel is not open
		if ((document.body.scrollTop > bannerHeight || document.documentElement.scrollTop > bannerHeight) 
			&& !collapsibleTocPanel.classList.contains('open')) {
			collapsibleTocBtn.classList.remove('hide')
		} else {
			collapsibleTocBtn.classList.add('hide')
		}
	}

	if (bannerEnabled && toc) {
		if (document.body.scrollTop > bannerHeight || document.documentElement.scrollTop > bannerHeight) {
			toc.classList.remove('toc-hide')
		} else {
			toc.classList.add('toc-hide')
		}
	}

	if (!bannerEnabled) return
	if (navbar) {
		// 动态获取根字体大小（随响应式断点变化：14px/15px/14px/13px）
		const rootFontSize = parseFloat(getComputedStyle(document.documentElement).fontSize);
		// 将 rem 单位转换为 px
		const navbarHeightPx = NAVBAR_HEIGHT * rootFontSize;
		const MAIN_PANEL_EXCESS_HEIGHT = MAIN_PANEL_OVERLAPS_BANNER_HEIGHT * rootFontSize;

		let bannerHeight = BANNER_HEIGHT
		if (document.body.classList.contains('is-home')) {
			bannerHeight = BANNER_HEIGHT_HOME
		}
		let threshold = window.innerHeight * (bannerHeight / 100) - navbarHeightPx - MAIN_PANEL_EXCESS_HEIGHT - rootFontSize;
		if (document.body.scrollTop >= threshold || document.documentElement.scrollTop >= threshold) {
			navbar.classList.add('navbar-hidden')
		} else {
			navbar.classList.remove('navbar-hidden')
		}
	}
}
window.onscroll = scrollFunction

// Collapsible TOC controls (BackToTop style - global handlers)
const toggleCollapsibleTOC = () => {
	const btn = document.getElementById('collapsible-toc-btn');
	const panel = document.getElementById('collapsible-toc-panel');
	if (!btn || !panel) return;

	const isOpening = !panel.classList.contains('open');
	
	if (isOpening) {
		// 动画时序：先移除 hidden（display:block），强制重排，再加 open（transform 动画）
		// 这样可以触发 CSS transition，否则会直接跳到最终状态
		panel.classList.remove('hidden');
		panel.offsetHeight; // 强制浏览器重排，确保 transition 生效
		panel.classList.add('open');
		btn.classList.add('hide');
		// 等待滑入动画完成（300ms transition + 50ms 缓冲）后同步 TOC 滚动位置
		setTimeout(() => {
			const tocComponent = panel.querySelector('table-of-contents') as TableOfContentsElement | null;
			tocComponent?.fallback?.();
			tocComponent?.update?.();
		}, 350);
	} else {
		closeCollapsibleTOC();
	}
};

const closeCollapsibleTOC = () => {
	const panel = document.getElementById('collapsible-toc-panel');
	if (!panel) return;
	panel.classList.remove('open'); // 触发滑出动画（300ms）
	// 等待动画结束后添加 hidden，避免面板仍在 DOM 中占用空间
	setTimeout(() => {
		if (!panel.classList.contains('open')) {
			panel.classList.add('hidden'); // display: none
		}
	}, 300); // 匹配 CSS transition-duration
	// 触发滚动事件，让 scrollFunction 重新评估按钮可见性
	window.dispatchEvent(new Event('scroll'));
};

// Expose to inline handlers
window.toggleCollapsibleTOC = toggleCollapsibleTOC;
window.closeCollapsibleTOC = closeCollapsibleTOC;

// 全局事件监听：点击 TOC 链接 / 按 ESC 关闭面板
// 使用 __collapsibleTocBound 标记防止重复绑定（Swup 不会重新加载 Layout 脚本）
if (!window.__collapsibleTocBound) {
	window.__collapsibleTocBound = true;
	// 点击 TOC 内链接时自动关闭面板（用户体验优化）
	document.addEventListener('click', e => {
		const panel = document.getElementById('collapsible-toc-panel');
		if (!panel || !panel.classList.contains('open')) return;
		const target = e.target as HTMLElement | null;
		if (target && target.closest && target.closest('#collapsible-toc-panel a')) {
			closeCollapsibleTOC();
		}
	});

	// ESC 键关闭面板（标准 UI 行为）
	document.addEventListener('keydown', e => {
		if (e.key === 'Escape') {
			closeCollapsibleTOC();
		}
	});
}

function init() {
	// disableAnimation()()		// TODO
	loadTheme();
	loadHue();
	setupExternalLinkWarmup(window.__externalLinkWarmupConfig);
	initCustomScrollbar();
	showBanner();
}

function initScrollElements() {
	// Initialize scroll-related elements and set initial state
	// This must run after DOM is fully loaded (CollapsibleTOC is in slot content)
	updateScrollElements();
	scrollFunction();
}

/* Load settings when entering the site */
init();

// Defer scroll element initialization until DOM is fully loaded
if (document.readyState === 'loading') {
	document.addEventListener('DOMContentLoaded', initScrollElements);
} else {
	// DOM already loaded (e.g., cached page), use rAF to ensure rendering is complete
	requestAnimationFrame(initScrollElements);
}

const setup = () => {
	// TODO: temp solution to change the height of the banner
/*
	window.swup.hooks.on('animation:out:start', () => {
		const path = window.location.pathname
		const body = document.querySelector('body')
		if (path[path.length - 1] === '/' && !body.classList.contains('is-home')) {
			body.classList.add('is-home')
		} else if (path[path.length - 1] !== '/' && body.classList.contains('is-home')) {
			body.classList.remove('is-home')
		}
	})
*/
	window.swup.hooks.on('link:click', () => {
		// Remove the delay for the first time page load
		document.documentElement.style.setProperty('--content-delay', '0ms')

		// prevent elements from overlapping the navbar
		if (!bannerEnabled) {
			return
		}
		const rootFontSize = parseFloat(getComputedStyle(document.documentElement).fontSize);
		const navbarHeightPx = NAVBAR_HEIGHT * rootFontSize;
		const MAIN_PANEL_EXCESS_HEIGHT = MAIN_PANEL_OVERLAPS_BANNER_HEIGHT * rootFontSize;
		let threshold = window.innerHeight * (BANNER_HEIGHT / 100) - navbarHeightPx - MAIN_PANEL_EXCESS_HEIGHT - rootFontSize;
		let navbar = document.getElementById('navbar-wrapper')
		if (!navbar || !document.body.classList.contains('is-home')) {
			return
		}
		if (document.body.scrollTop >= threshold || document.documentElement.scrollTop >= threshold) {
			navbar.classList.add('navbar-hidden')
		}
	})
	// Swup 钩子：visit:start - 页面切换开始（点击链接后，内容替换前）
	window.swup.hooks.on('visit:start', (visit: {to: {url: string}}) => {
		// 立即关闭 CollapsibleTOC 面板，避免页面过渡期间的视觉问题
		// 如果不这样做，面板会先滑动到正文区内（因为容器高度变化），再被 Swup 移除
		const collapsibleTocPanel = document.getElementById('collapsible-toc-panel');
		if (collapsibleTocPanel) {
			collapsibleTocPanel.classList.remove('open');   // 移除打开状态
			collapsibleTocPanel.classList.add('hidden');    // 立即隐藏（不等动画）
		}

		// Clean up previous KaTeX observer to prevent memory leaks
		if (katexObserver) {
			katexObserver.disconnect();
			katexObserver = null;
		}

		// Add a class to the body to hide new content via CSS until the scroll animation is finished
		document.body.classList.add('is-transitioning');

		// change banner height immediately when a link is clicked
		const bodyElement = document.querySelector('body')
		const isHomePage = pathsEqual(visit.to.url, url('/'))
		
		bodyElement!.classList.toggle('is-home', isHomePage);

		// Control banner text visibility based on page
		const bannerTextOverlay = document.querySelector('.banner-text-overlay')
		if (bannerTextOverlay) {
			bannerTextOverlay.classList.toggle('hidden', !isHomePage);
		}

		// increase the page height during page transition to prevent the scrolling animation from jumping
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) {
			heightExtend.classList.remove('hidden')
		}

		// Hide the TOC while scrolling back to top
		let toc = document.getElementById('toc-wrapper');
		if (toc) {
			toc.classList.add('toc-not-ready')
		}
	});

	window.swup.hooks.on('content:replace', () => {
		initCustomScrollbar();
		// Update element references after DOM replacement
		updateScrollElements();
	});

	// Swup 钩子：visit:end - 滚动动画完成后
	window.swup.hooks.on('visit:end', (_visit: {to: {url: string}}) => {
		// 初始化 CollapsibleTOC 按钮的滚动可见性
		// 关键问题：CollapsibleTOC 在 #swup-container 内，Swup 会重新渲染 DOM
		// 但在 visit:end 触发时，新 DOM 可能还没完全插入，需要处理时序
		const initCollapsibleTocBtn = () => {
			const btn = document.getElementById('collapsible-toc-btn');
			if (btn) {
				// 元素已存在，直接更新可见性
				scrollFunction();
			} else {
				// 元素尚未渲染，使用 MutationObserver 等待
				// 这种情况在快速导航或慢速设备上可能发生
				const observer = new MutationObserver(() => {
					if (document.getElementById('collapsible-toc-btn')) {
						observer.disconnect();
						scrollFunction();
					}
				});
				observer.observe(document.body, { childList: true, subtree: true });
				// 2 秒超时防止内存泄漏（如果页面没有 CollapsibleTOC）
				setTimeout(() => observer.disconnect(), 2000);
			}
		};

		// Use a small timeout to ensure the browser has finished painting after the scroll
		setTimeout(() => {
			// Remove the helper class to allow the content animations to play
			document.body.classList.remove('is-transitioning');

			// Hide the temporary height element
			const heightExtend = document.getElementById('page-height-extend')
			if (heightExtend) {
				heightExtend.classList.add('hidden')
			}

			// Show the TOC again
			const toc = document.getElementById('toc-wrapper');
			if (toc) {
				toc.classList.remove('toc-not-ready')
			}

			// Initialize CollapsibleTOC button with MutationObserver fallback
			initCollapsibleTocBtn();
		}, 50); // A small buffer is enough
	});
}
if (window?.swup?.hooks) {
	setup()
} else {
	document.addEventListener('swup:enable', setup)
}

// scrollFunction and scroll-related variables are now defined above init()

window.onresize = () => {
	// calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
	let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
	offset = offset - offset % 4;
	document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
}

</script>

<script>
import PhotoSwipeLightbox from "photoswipe/lightbox"
import "photoswipe/style.css"

let lightbox: PhotoSwipeLightbox
let pswp = import("photoswipe")

function createPhotoSwipe() {
	lightbox = new PhotoSwipeLightbox({
		gallery: ".custom-md img, #post-cover img",
		pswpModule: () => pswp,
		closeSVG: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#ffffff"><path d="M480-424 284-228q-11 11-28 11t-28-11q-11-11-11-28t11-28l196-196-196-196q-11-11-11-28t11-28q11-11 28-11t28 11l196 196 196-196q11-11 28-11t28 11q11 11 11 28t-11 28L536-480l196 196q11 11 11 28t-11 28q-11 11-28 11t-28-11L480-424Z"/></svg>',
		zoomSVG: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#ffffff"><path d="M340-540h-40q-17 0-28.5-11.5T260-580q0-17 11.5-28.5T300-620h40v-40q0-17 11.5-28.5T380-700q17 0 28.5 11.5T420-660v40h40q17 0 28.5 11.5T500-580q0 17-11.5 28.5T460-540h-40v40q0 17-11.5 28.5T380-460q-17 0-28.5-11.5T340-500v-40Zm40 220q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l224 224q11 11 11 28t-11 28q-11 11-28 11t-28-11L532-372q-30 24-69 38t-83 14Zm0-80q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg>',
		padding: { top: 20, bottom: 20, left: 20, right: 20 },
		wheelToZoom: true,
		arrowPrev: false,
		arrowNext: false,
		imageClickAction: 'close',
		tapAction: 'close',
		doubleTapAction: 'zoom',
	})

	lightbox.addFilter("domItemData", (itemData, element) => {
		if (element instanceof HTMLImageElement) {
			itemData.src = element.src

			itemData.w = Number(element.naturalWidth || window.innerWidth)
			itemData.h = Number(element.naturalHeight || window.innerHeight)

			itemData.msrc = element.src
		}

		return itemData
	})

	lightbox.init()
}

const setup = () => {
	if (!lightbox) {
		createPhotoSwipe()
	}
	window.swup.hooks.on("page:view", () => {
		createPhotoSwipe()
	})

	window.swup.hooks.on(
		"content:replace",
		() => {
			lightbox?.destroy?.()
		},
		{ before: true },
	)
}

if (window.swup) {
	setup()
} else {
	document.addEventListener("swup:enable", setup)
}
</script>
